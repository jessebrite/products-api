name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  lint:
    name: Lint (Python ${{ matrix.python-version }})

    env:
      CI: true

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Security checks
        run: |
          echo "Upgrade and install security tools"
          pip install --upgrade pip
          pip install pip-audit ruff semgrep mypy
          echo "Running security checks"
          pip-audit --desc --fix  # auto-fix if possible
          ruff check . --output-format=github   # GitHub annotations
          semgrep ci --config p/python --config p/fastapi
          # mypy src/  # type checking

  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest-cov -r requirements.txt

      - name: Run unit tests (parallel)
        timeout-minutes: 5
        run: |
          echo "Starting unit tests at $(date)"
          pytest tests/unit \
            -m "not integration" \
            --tb=long --durations=10 -v \
            --cov=src \
            --cov-report=term \
            --cov-report=xml \
            --cov-fail-under=80
          echo "Unit tests finished at $(date)"

  integration-tests:
    name: Integration Tests (Python ${{ matrix.python-version }})
    needs: [lint, unit-tests]   # Only run if lint + unit pass
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest-cov -r requirements.txt

      - name: Clean up old test DB
        run: |
          rm -f test_ci.db

      - name: Run integration tests
        env:
          CI: true
        timeout-minutes: 8
        run: |
          echo "Starting integration tests at $(date)"
          pytest tests/integration \
            -m integration --tb=long --durations=5 -v \
            --cov=src \
            --cov-report=term \
            --cov-report=xml \
            --cov-fail-under=80
          echo "Integration tests finished at $(date)"
